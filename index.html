<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Distance-Based Synth</title>
  <style>
    body { font-family: sans-serif; background: #111; color: #eee; text-align: center; padding: 2em; }
    #status { margin: 1em 0; font-size: 1.2em; }
    canvas { display: block; margin: 1em auto; background: #222; }
  </style>
</head>
<body>
  <h1>Distance-Based Synth</h1>
  <p>Move to change the sound based on distance from locked position.</p>
  <div id="status">Waiting for user interaction...</div>
  <button id="lockBtn">Lock Position</button>
  <canvas id="visual" width="300" height="100"></canvas>
  <script>
    let audioCtx, osc;
    let baseLat = null, baseLon = null;
    let watchID = null;
    let midiOut = null;
    let currentSpeed = 0;

    const visual = document.getElementById('visual');
    const ctx = visual.getContext('2d');
    const status = document.getElementById('status');

    let accelerationMagnitude = 0;

    // Accelerometer
    if (window.DeviceMotionEvent) {
      window.addEventListener('devicemotion', (event) => {
        const ax = event.acceleration.x || 0;
        const ay = event.acceleration.y || 0;
        const az = event.acceleration.z || 0;
        accelerationMagnitude = Math.sqrt(ax*ax + ay*ay + az*az);
      });
    }

    function deg2rad(deg) {
      return deg * (Math.PI / 180);
    }

    function getDistanceFromLatLonInM(lat1, lon1, lat2, lon2) {
      const R = 6371e3; // Earth radius in m
      const dLat = deg2rad(lat2 - lat1);
      const dLon = deg2rad(lon2 - lon1);
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function updateSynth(distance) {
      if (!osc) return;

      const minFreq = 200;
      const maxFreq = 2000;
      const clampedDist = Math.min(Math.max(distance, 0), 100);
      const freq = minFreq + (maxFreq - minFreq) * (clampedDist / 100);

      const tempoMod = accelerationMagnitude * 20; // Arbitrary scale

      osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
      status.textContent += ` | Freq: ${Math.round(freq)} Hz | Acc: ${accelerationMagnitude.toFixed(2)}`;

      // MIDI Out
      if (midiOut) {
        const midiFreq = Math.min(127, Math.round((freq / maxFreq) * 127));
        midiOut.send([0x90, midiFreq, 127]);
      }

      // Visual
      ctx.clearRect(0, 0, 300, 100);
      ctx.fillStyle = 'lime';
      ctx.fillRect(0, 50 - (freq - minFreq) / (maxFreq - minFreq) * 50, 300, 2);
    }

    function startAudio() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        osc = audioCtx.createOscillator();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(440, audioCtx.currentTime);
        osc.connect(audioCtx.destination);
        osc.start();
      }
    }

    document.body.addEventListener('click', startAudio);

    document.getElementById('lockBtn').onclick = () => {
      navigator.geolocation.getCurrentPosition(pos => {
        baseLat = pos.coords.latitude;
        baseLon = pos.coords.longitude;
        status.textContent = `Position locked: ${baseLat.toFixed(5)}, ${baseLon.toFixed(5)}`;

        setInterval(() => {
          navigator.geolocation.getCurrentPosition(onPositionUpdate, onPositionError, {
            enableHighAccuracy: true,
            timeout: 1000,
            maximumAge: 0
          });
        }, 1000);

   
      }, err => {
        status.textContent = 'Error locking position: ' + err.message;
      }, {
        enableHighAccuracy: true,
        timeout: 1000,
        maximumAge: 0
      });
    };

    function onPositionUpdate(position) {
      if (baseLat === null || baseLon === null) return;
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;
      const dist = getDistanceFromLatLonInM(baseLat, baseLon, lat, lon);

      status.textContent = `Lat: ${lat.toFixed(5)} Lon: ${lon.toFixed(5)} Acc: ${position.coords.accuracy}m Dist: ${dist.toFixed(2)}m`;
      updateSynth(dist);
    }

    function onPositionError(err) {
      status.textContent = 'Geolocation error: ' + err.message;
    }

    // MIDI Setup
    if (navigator.requestMIDIAccess) {
      navigator.requestMIDIAccess().then(midi => {
        const outputs = [...midi.outputs.values()];
        if (outputs.length > 0) {
          midiOut = outputs[0];
          console.log('MIDI ready');
        }
      });
    }
  </script>
</body>
</html>
