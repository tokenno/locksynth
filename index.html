<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GPS Lock Synth + MIDI</title>
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    padding: 2em;
    background: #222;
    color: #eee;
  }
  button, select {
    font-size: 1.1em;
    padding: 0.6em 1.2em;
    margin: 1em 0.5em 1em 0.5em;
    cursor: pointer;
    background: #0a84ff;
    border: none;
    border-radius: 5px;
    color: white;
  }
  #status {
    margin: 1em 0;
    font-size: 1em;
    min-height: 1.4em;
  }
  #freq {
    font-weight: bold;
    font-size: 2em;
    margin-top: 1em;
    letter-spacing: 0.1em;
  }
  label {
    font-size: 1em;
    margin-right: 0.5em;
  }
</style>
</head>
<body>

<h1>GPS Lock Synth + MIDI Out</h1>

<button id="lockBtn">Lock Position & Start Synth</button>

<div>
  <label for="midiSelect">Select MIDI Output:</label>
  <select id="midiSelect" disabled>
    <option>Loading MIDI devices...</option>
  </select>
</div>

<div id="status">Click the button to lock your position.</div>
<div>Current frequency: <span id="freq">--</span> Hz</div>

<script>
(() => {
  const lockBtn = document.getElementById('lockBtn');
  const status = document.getElementById('status');
  const freqDisplay = document.getElementById('freq');
  const midiSelect = document.getElementById('midiSelect');

  let audioCtx = null;
  let osc = null;
  let watchId = null;
  let lockedPos = null;

  const minFreq = 200;
  const maxFreq = 2000;
  const maxDistance = 10; // meters, smaller for sensitivity

  // MIDI
  let midiAccess = null;
  let midiOutput = null;

  function distanceMeters(lat1, lon1, lat2, lon2) {
    const R = 6371000; // Earth radius meters
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  function mapRange(value, inMin, inMax, outMin, outMax) {
    return outMin + (value - inMin) * (outMax - outMin) / (inMax - inMin);
  }

  function freqToMidiNote(freq) {
    // MIDI note = 69 + 12*log2(freq/440)
    return Math.round(69 + 12 * Math.log2(freq / 440));
  }

  function startAudio() {
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioCtx.state === 'suspended') {
      audioCtx.resume();
    }
    if (!osc) {
      osc = audioCtx.createOscillator();
      osc.type = 'sine';
      osc.frequency.value = minFreq;
      osc.connect(audioCtx.destination);
      osc.start();
    }
  }

  function stopAudio() {
    if (osc) {
      osc.stop();
      osc.disconnect();
      osc = null;
    }
    if (audioCtx) {
      audioCtx.close();
      audioCtx = null;
    }
  }

  function sendMidiNote(note) {
    if (midiOutput) {
      // Note On, channel 1, velocity 100
      midiOutput.send([0x90, note, 100]);
      // Note Off after 200 ms
      setTimeout(() => {
        midiOutput.send([0x80, note, 0]);
      }, 200);
    }
  }

  function updateFrequency(distance) {
    const d = Math.min(distance, maxDistance);
    const freq = mapRange(d, 0, maxDistance, minFreq, maxFreq);
    if (osc && audioCtx) {
      osc.frequency.setTargetAtTime(freq, audioCtx.currentTime, 0.05);
      freqDisplay.textContent = freq.toFixed(1);
      const midiNote = freqToMidiNote(freq);
      sendMidiNote(midiNote);
      console.log(`Distance: ${distance.toFixed(2)} m, Freq: ${freq.toFixed(1)} Hz, MIDI Note: ${midiNote}`);
    }
  }

  function onPositionUpdate(position) {
    if (!lockedPos) return;

    const dist = distanceMeters(
      lockedPos.latitude, lockedPos.longitude,
      position.coords.latitude, position.coords.longitude
    );

    updateFrequency(dist);
    status.textContent = `Distance from locked point: ${dist.toFixed(2)} meters`;
  }

  function onPositionError(err) {
    status.textContent = `Geolocation error: ${err.message} (code ${err.code})`;
  }

  // MIDI setup and selection
  function onMIDISuccess(midi) {
    midiAccess = midi;
    refreshMIDIPorts();
    midiAccess.onstatechange = refreshMIDIPorts;
  }

  function onMIDIFailure() {
    status.textContent = 'Could not access your MIDI devices.';
    midiSelect.disabled = true;
  }

  function refreshMIDIPorts() {
    const outputs = Array.from(midiAccess.outputs.values());
    midiSelect.innerHTML = '';
    if (outputs.length === 0) {
      midiSelect.innerHTML = '<option>No MIDI outputs found</option>';
      midiSelect.disabled = true;
      midiOutput = null;
    } else {
      outputs.forEach((output, i) => {
        const option = document.createElement('option');
        option.value = output.id;
        option.textContent = output.name;
        midiSelect.appendChild(option);
      });
      midiSelect.disabled = false;
      // Select first output by default
      midiOutput = outputs[0];
      midiSelect.value = midiOutput.id;
    }
  }

  midiSelect.addEventListener('change', () => {
    if (midiAccess) {
      const selectedId = midiSelect.value;
      midiOutput = midiAccess.outputs.get(selectedId) || null;
    }
  });

  lockBtn.addEventListener('click', () => {
    if (!navigator.geolocation) {
      status.textContent = 'Geolocation is not supported by your browser.';
      return;
    }

    lockBtn.disabled = true;
    status.textContent = 'Requesting position permission...';

    startAudio();

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        lockedPos = {
          latitude: pos.coords.latitude,
          longitude: pos.coords.longitude
        };
        status.textContent = `Position locked at ${lockedPos.latitude.toFixed(5)}, ${lockedPos.longitude.toFixed(5)}. Watching position...`;

        if (watchId) navigator.geolocation.clearWatch(watchId);
        watchId = navigator.geolocation.watchPosition(
          onPositionUpdate,
          onPositionError,
          { enableHighAccuracy: true, maximumAge: 0, timeout: 2000 }
        );
      },
      (err) => {
        status.textContent = `Error locking position: ${err.message} (code ${err.code})`;
        lockBtn.disabled = false;
      },
      { enableHighAccuracy: true, maximumAge: 0, timeout: 2000 }
    );
  });

  window.addEventListener('beforeunload', () => {
    if (watchId) navigator.geolocation.clearWatch(watchId);
    stopAudio();
  });

  // Initialize MIDI on page load
  if (navigator.requestMIDIAccess) {
    navigator.requestMIDIAccess().then(onMIDISuccess, onMIDIFailure);
  } else {
    status.textContent = 'Web MIDI API not supported in this browser.';
    midiSelect.disabled = true;
  }
})();
</script>

</body>
</html>

