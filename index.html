<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GPS Distance Synth</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 2em; }
    canvas { border: 1px solid black; margin-top: 1em; }
  </style>
</head>
<body>
  <h1>GPS Distance Synth</h1>
  <button id="startButton">Start Synth</button>
  <p id="status">Waiting for user interaction...</p>
  <canvas id="visual" width="300" height="100"></canvas>

  <script>
    let audioCtx, osc, gain;
    let baseLat = null, baseLon = null;
    let freqMin = 200;
    let freqMax = 2000;
    let watchID = null;

    const status = document.getElementById("status");
    const canvas = document.getElementById("visual");
    const ctx = canvas.getContext("2d");

    function startAudio() {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      osc = audioCtx.createOscillator();
      gain = audioCtx.createGain();
      osc.type = 'sine';
      osc.connect(gain).connect(audioCtx.destination);
      osc.start();
    }

    function updateVisual(freq) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "blue";
      let width = (freq - freqMin) / (freqMax - freqMin) * canvas.width;
      ctx.fillRect(0, 0, width, canvas.height);
    }

    function haversineDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3; // meters
      const toRad = deg => deg * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function onPositionUpdate(pos) {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      if (baseLat === null || baseLon === null) {
        baseLat = lat;
        baseLon = lon;
        status.textContent = "Position locked. Move around.";
        return;
      }

      const distance = haversineDistance(baseLat, baseLon, lat, lon);
      const clampedDistance = Math.min(distance, 100); // cap to 100m for mapping
      const freq = freqMin + (freqMax - freqMin) * (clampedDistance / 100);
      if (osc) osc.frequency.setValueAtTime(freq, audioCtx.currentTime);

      status.textContent = `Distance: ${distance.toFixed(2)} m â€” Frequency: ${Math.round(freq)} Hz`;
      updateVisual(freq);
    }

    function onPositionError(err) {
      status.textContent = `Geolocation Error: ${err.message}`;
    }

    document.getElementById("startButton").addEventListener("click", () => {
      startAudio();
      status.textContent = "Waiting for GPS lock...";
      watchID = navigator.geolocation.watchPosition(
        onPositionUpdate,
        onPositionError,
        {
          enableHighAccuracy: true,
          maximumAge: 0,
          timeout: 5000
        }
      );
    });
  </script>
</body>
</html>


